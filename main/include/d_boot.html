<!doctype html>
<!--suppress ALL -->
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <!-- Jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.js"></script>
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
            crossorigin="anonymous"></script>

    <title>Dragrace</title>

    <script>

   /**
    *
    *Programme für Dragrace
    *
    *
    **/

        var t_l1,t_l2,t_l3;
        const ESP32_URL = "http://192.168.1.115";
        const ACTION_URL = ESP32_URL+"/zahl";

        //Json Daten von ESP32 lesen
        function d_json(url){
            $.getJSON ( url )
                .done(function( json ) {
                    $('#zahl').text(JSON.stringify(json));
                    $(':button').removeClass("btn-success");
                    // $('#stat :button').removeClass("btn-success");
                    $('#start').unbind();

                    if(json.Status & (1)){ //Gestartet
                        $('#bt_state_startet').addClass("btn-success");
                    }
                    if(json.Status & (1<<1)){ //Läuft
                        $('#bt_state_runing').addClass("btn-success");
                        $('#start').click(function (){
                            $('#start').unbind();
                            // $.get("http://192.168.1.106/start?action=neu");
                            d_json(ACTION_URL+"?action=neu")
                            t_l1=0;t_l3=0;t_l3=0;

                        });
                        $('#start').removeClass('btn-primary btn-success');
                        $('#start').addClass('btn-danger');
                        $('#start').html('Stop');

                    }
                    if(json.Status & (1<<2)){ //Ready
                        $('#bt_state_ready').addClass("btn-success");
                        $('#start').click(function (){
                            $('#start').unbind();
                            // $.get("http://192.168.1.106/start?action=start");
                            d_json(ACTION_URL+"?action=start")

                        });
                            $('#start').removeClass('btn-primary btn-danger');
                            $('#start').addClass('btn-success');
                        $('#start').html('Start');
                    }
                    if(json.Status & (1<<3)){//Fertig
                        $('#bt_state_finsish').addClass("btn-success");
                    }

                    if(json.Status & (1<<8)){//L1
                        $('#bt_state_L1').addClass("btn-success");
                        t_l1=json.Zeit_L1
                        // $('#L1').text((json.Zeit_L1-json.Start)/80000000);
                    }
                    if(json.Status & (1<<9)){//L2
                        $('#bt_state_L2').addClass("btn-success");
                        // t_l2=(json.Zeit_L2-json.Start)/80000000;
                    }
                    if(json.Status & (1<<10)){//L3
                        $('#bt_state_L3').addClass("btn-success");
                        // t_l3=(json.Zeit_L3-json.Start)/80000000;
                        // $('#L3').text(t_l3);
                        // $('#L2').text((t_l3-t_l2)*100/3600);
                    }
                    if(json.Status & (1<<11)){//Frühstart Links
                        $('#bt_state_lFuehstart').addClass("btn-success");
                    }
                    if(json.Status & (1<<12)){//Sieg Links
                        $('#bt_state_LSieg').addClass("btn-success");
                    }

                    //zeiten
                    $('#L1').text((json.Zeit_L1));
                    $('#L2').text((json.Zeit_L2));
                    $('#L3').text((json.Zeit_L3));
                    // $('#L1').text((json.Zeit_L1-json.Start)/80000000);




                })
                .fail(function( jqxhr, textStatus, error ) {
                    var err = textStatus + ", " + error;
                    console.log( "Request Failed: " + err );
                })
            ;
        }
        /**
        Dokument geladen
         */
        $(document).ready(function () {
            var refreshInterval = '';

            $.ajaxSetup({timeout:5000}); //in milliseconds

            // Auto Refresh on
            refreshInterval=setInterval(function(){
                d_json(ACTION_URL);
                $('#auto-refresh').html('Stop auto Refresh');
            },500);


            // Reload Knopf
            $("#refresh").hide();
            $("#refresh").click(function () {
                d_json(ACTION_URL);
            });

            // Start Knopf
            $("#start").click(function () {
                // $.get("http://192.168.1.106/start?action=start");
            });

            // Refresh Checkbox
            $('#refresh-check-box').prop('checked',true);
            $('#refresh-check-box').click(function (){
                if($('#refresh-check-box').is(':checked')){
                    // Refresh on
                    refreshInterval=setInterval(function(){
                        $("#refresh").hide();
                        d_json(ACTION_URL);
                    },500);
                }else{
                    clearInterval(refreshInterval);
                    $("#refresh").show();
                }
            });

            // Simulator
            $('#bt_sim_L1').click(function (){d_json(ACTION_URL+"?action=L1");})
            $('#bt_sim_L2').click(function (){d_json(ACTION_URL+"?action=L2");})
            $('#bt_sim_L3').click(function (){d_json(ACTION_URL+"?action=L3");})
            $('#bt_sim_R1').click(function (){d_json(ACTION_URL+"?action=R1");})
            $('#bt_sim_R2').click(function (){d_json(ACTION_URL+"?action=R2");})
            $('#bt_sim_R3').click(function (){d_json(ACTION_URL+"?action=R3");})
            // $('#bt_sim_L1').click(function (){$.get("http://192.168.1.106/start?action=L1");})
            // $('#bt_sim_L2').click(function (){$.get("http://192.168.1.106/start?action=L2");})
            // $('#bt_sim_L3').click(function (){$.get("http://192.168.1.106/start?action=L3");})
            // $('#bt_sim_R1').click(function (){$.get("http://192.168.1.106/start?action=R1");})
            // $('#bt_sim_R2').click(function (){$.get("http://192.168.1.106/start?action=R2");})
            // $('#bt_sim_R3').click(function (){$.get("http://192.168.1.106/start?action=R3");})


        });
    </script>

</head>

<body>


<div class="container text-center">

    <!--Bedinung-->
    <div class="card">
        <div class="card-header h1"> Dragrace</div>
        <div class="card-body h-50">
            <!--Start-Knopf-->
            <button style="height: 100px !important;" id="start" type="button" class="w-100 btn h-75 btn-primary">Start</button>
            <!--Auto Refresh checkbox-->
            <div class="form-check d-md-inline-block" style="text-align: left!important;">
                <input class="form-check-input" type="checkbox" value="1" id="refresh-check-box">
                <label class="form-check-label"  for="refresh-check-box">
                    auto Refresh
                </label>
            </div>
            <!--Auto Refresh-Knopf-->
            <!--<button id="auto-refresh" type="button" class=" btn  btn-info mt-1">Start auto Refresh</button>-->
            <!--Refresh-Knopf-->
            <button id="refresh" type="button" class=" btn  btn-info mt-1">Reload</button>
        </div>
    </div>
    <!--Ausgabe Status-->
    <div id="stat" class="card mt-3">
        <div class="card-header "> Status</div>
        <div class="card-body h-50 ">
            <button id="bt_state_ready">Ready</button>
            <button id="bt_state_startet">Gestartet</button>
            <button id="bt_state_runing">Läuft</button>
            <button id="bt_state_finsish">Fertig</button>
        </div>
    </div>
    <!--Ausgabe Zeiten-->
    <div class="card mt-3">
        <div class="card-header "> Zeit</div>
        <div class="card-body h-50 ">
            <div class="container">
                <div class="row">
                    <div class="col">
                        <!--Links-->
                        <div class="card border-1">
                            <div class="card-header">Links </div>
                            <div class="card-body">
                                <button id="bt_state_L1">L1</button>
                                <button id="bt_state_L2">L2</button>
                                <button id="bt_state_L3">L3</button>
                                <button id="bt_state_LSieg">Sieg</button>
                                <button id="bt_state_lFuehstart">Frühstart</button>
                                <p> <span>1: </span><span  id="L1"></span> Sek.</p>
                                <p> <span>1: </span><span  id="L2"></span> Km/h</p>
                                <p> <span>2: </span><span  id="L3"></span> Sek.</p>

                            </div>
                        </div>

                    </div>
                    <div class="col">
                        <!--Rechts-->
                        <div class="card">
                            <div class="card-header">Rechts </div>
                        </div>

                    </div>

                </div>
            </div>
            <p id="zahl">Zahl</p>
        </div>
    </div>

    <!--Simulator-->
    <div id="sim" class="card mt-3">
        <div class="card-header "> Lichtschranken Simulator</div>
        <div class="card-body h-50 ">
            <button id="bt_sim_L1">L1</button>
            <button id="bt_sim_L2">L2</button>
            <button id="bt_sim_L3">L3</button>
            <button id="bt_sim_R1">R1</button>
            <button id="bt_sim_R2">R2</button>
            <button id="bt_sim_R3">R3</button>
        </div>
    </div>



</div>



</body>
</html>