<!doctype html>
<!--suppress ALL -->
<html lang="en">
<head>
    <!-----------------------------------------
         Internet Seite für Dragrace Steuerung
    ------------------------------------------->
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <!-- Jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.js"></script>
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
            crossorigin="anonymous"></script>

    <title>Dragrace</title>

    <script>

   /**
    *
    *Programme für Dragrace
    *
    *
    **/

   var t_l1, t_l2, t_l3;
   const ESP32_URL = "http://espressif";
   // const ESP32_URL = "http://192.168.1.115";
   const ACTION_URL = ESP32_URL + "/zahl";

   const Drag_Status = {
       none: 0,
       Gestartet: 1 << 1 - 1,
       Laeuft: 1 << 2 - 1,
       Ready: 1 << 3 - 1,
       Fertig: 1 << 4 - 1,
       Links_Start: 1 << 9 - 1,
       Links_Start_Ausgewertet: 1 << 10 - 1,
       Links_Ziel_Ausgewertet: 1 << 11 - 1,
       Links_Lichschr1: 1 << 12 - 1,
       Links_Lichschr2: 1 << 13 - 1,
       Links_Lichschr3: 1 << 14 - 1,
       Links_Fruehstart: 1 << 15 - 1,
       Links_Sieg: 1 << 16 - 1,
       Rechts_Start: 1 << 17 - 1,
       Rechts_Start_Ausgewertet: 1 << 18 - 1,
       Rechts_Ziel_Ausgewertet: 1 << 19 - 1,
       Rechts_Lichschr1: 1 << 20 - 1,
       Rechts_Lichschr2: 1 << 21 - 1,
       Rechts_Lichschr3: 1 << 22 - 1,
       Rechts_Fruehstart: 1 << 23 - 1,
       Rechts_Sieg: 1 << 24 - 1,
   };

        //Json Daten von ESP32 lesen
        function d_json(url){
            $.getJSON ( url )
                .done(function( json ) {
                    $('#zahl').text(JSON.stringify(json));
                    $(':button').removeClass("btn-success");
                    // $('#stat :button').removeClass("btn-success");
                    $('#start').unbind();

                    if(json.Status & Drag_Status.Gestartet){ //Gestartet
                        $('#bt_state_startet').addClass("btn-success");
                    }
                    if(json.Status & Drag_Status.Laeuft)            //Läuft
                        $('#bt_state_runing').addClass("btn-success");
                    
                    if(json.Status & Drag_Status.Laeuft || json.Status & Drag_Status.Fertig){           //Läuft
                        $('#start').click(function (){
                            $('#start').unbind();
                            d_json(ACTION_URL+"?action=neu")
                            t_l1=0;t_l3=0;t_l3=0;

                        });
                        $('#start').removeClass('btn-primary btn-success');
                        $('#start').addClass('btn-danger');
                        $('#start').html('Stop');

                    }
                    if(json.Status & Drag_Status.Ready){            //Ready
                        $('#bt_state_ready').addClass("btn-success");
                        $('#start').click(function (){
                            $('#start').unbind();
                            d_json(ACTION_URL+"?action=start")

                        });
                            $('#start').removeClass('btn-primary btn-danger');
                            $('#start').addClass('btn-success');
                        $('#start').html('Start');
                    }
                    if(json.Status & Drag_Status.Fertig){           //Fertig
                        $('#bt_state_finsish').addClass("btn-success");
                    }

                    if(json.Status & Drag_Status.Links_Start){      //Start
                        $('#bt_state_LStart').addClass("btn-success");
                        t_l1=json.Zeit_L1
                    }
                    if(json.Status & Drag_Status.Links_Lichschr1){  //L1
                        $('#bt_state_L1').addClass("btn-success");
                        t_l1=json.Zeit_L1
                    }
                    if(json.Status & Drag_Status.Links_Lichschr2){  //L2
                        $('#bt_state_L2').addClass("btn-success");
                        // t_l2=(json.Zeit_L2-json.Start)/80000000;
                    }
                    if(json.Status & Drag_Status.Links_Lichschr3){  //L3
                        $('#bt_state_L3').addClass("btn-success");
                        // t_l3=(json.Zeit_L3-json.Start)/80000000;
                        // $('#L3').text(t_l3);
                        // $('#L2').text((t_l3-t_l2)*100/3600);
                    }
                    if(json.Status & Drag_Status.Links_Fruehstart){ //Frühstart Links
                        $('#bt_state_lFuehstart').addClass("btn-success");
                    }
                    if(json.Status & Drag_Status.Links_Sieg){       //Sieg Links
                        $('#bt_state_LSieg').addClass("btn-success");
                    }
                    //Zufall Start
                    $('#random').text(json.rand/100);

                    /// Zeiten
                    var Start_Links=    json.Start_Links;
                    var L1 =            json.Zeit_L1;
                    var L2,L3;
                        L2 =            json.Zeit_L2;
                        L3 =            json.Zeit_L3;
                    var COUNTS_PRO_SEC=  80e6; //80 Millionen (Zähler wird mit 80MHz getaktet)

                    //Reaktionszeit
                    var r = L1- Start_Links;
                    $('#LReak').text(r/COUNTS_PRO_SEC+" Sec. ("+r+")");

                    //Lichtschranken
                    $('#L1').text((L1 - Start_Links)/COUNTS_PRO_SEC+" Sec.");
                    if (json.Status&Drag_Status.Links_Lichschr3){
                        var LICHTSCHRANKEN_ABSTAND_IN_KM = 0.0001;
                        var COUNTS_BEI_1_KMH_UND_LICHTSCHRANKENABSTAND_X = COUNTS_PRO_SEC/(1/LICHTSCHRANKEN_ABSTAND_IN_KM) * 3600;
                        var kmh = COUNTS_BEI_1_KMH_UND_LICHTSCHRANKENABSTAND_X / (L3-L2);
                        kmh=Math.round(kmh*1000)/1000;
                        $('#L2').text(kmh +" km/h");
                        var gesamtzeit= Math.round((L3 - Start_Links)/COUNTS_PRO_SEC*1000)/1000
                        $('#L3').text(gesamtzeit+" Sec.");
                    }else{
                        $('#L2').text(0);
                        $('#L3').text(0);
                    }
            // $('#L1').text((json.Zeit_L1-json.Start)/80000000);




                })
                .fail(function( jqxhr, textStatus, error ) {
                    var err = textStatus + ", " + error;
                    console.log( "Request Failed: " + err );
                })
            ;
        }
        /**
        Dokument geladen
         */
        $(document).ready(function () {
            var refreshInterval = '';

            $.ajaxSetup({timeout:5000}); //in milliseconds

            // Auto Refresh on
            refreshInterval=setInterval(function(){
                d_json(ACTION_URL);
                $('#auto-refresh').html('Stop auto Refresh');
            },500);


            // Reload Knopf
            $("#refresh").hide();
            $("#refresh").click(function () {
                d_json(ACTION_URL);
            });

            // Start Knopf
            $("#start").click(function () {
                // $.get("http://192.168.1.106/start?action=start");
            });

            // Refresh Checkbox
            $('#refresh-check-box').prop('checked',true);
            $('#refresh-check-box').click(function (){
                if($('#refresh-check-box').is(':checked')){
                    // Refresh on
                    refreshInterval=setInterval(function(){
                        $("#refresh").hide();
                        d_json(ACTION_URL);
                    },500);
                }else{
                    clearInterval(refreshInterval);
                    $("#refresh").show();
                }
            });

            // Simulator
            $('#bt_sim_L1').click(function (){d_json(ACTION_URL+"?action=L1");})
            $('#bt_sim_L2').click(function (){d_json(ACTION_URL+"?action=L2");})
            $('#bt_sim_L3').click(function (){d_json(ACTION_URL+"?action=L3");})
            $('#bt_sim_R1').click(function (){d_json(ACTION_URL+"?action=R1");})
            $('#bt_sim_R2').click(function (){d_json(ACTION_URL+"?action=R2");})
            $('#bt_sim_R3').click(function (){d_json(ACTION_URL+"?action=R3");})
            // $('#bt_sim_L1').click(function (){$.get("http://192.168.1.106/start?action=L1");})
            // $('#bt_sim_L2').click(function (){$.get("http://192.168.1.106/start?action=L2");})
            // $('#bt_sim_L3').click(function (){$.get("http://192.168.1.106/start?action=L3");})
            // $('#bt_sim_R1').click(function (){$.get("http://192.168.1.106/start?action=R1");})
            // $('#bt_sim_R2').click(function (){$.get("http://192.168.1.106/start?action=R2");})
            // $('#bt_sim_R3').click(function (){$.get("http://192.168.1.106/start?action=R3");})


        });
    </script>

</head>

<body>


<div class="container text-center">

    <!--Bedinung-->
    <div class="card">
        <div class="card-header h1"> Dragrace</div>
        <div class="card-body h-50">
            <!--Start-Knopf-->
            <button style="height: 100px !important;" id="start" type="button" class="w-100 btn h-75 btn-primary">Start</button>
            <!--Auto Refresh checkbox-->
            <div class="form-check d-md-inline-block" style="text-align: left!important;">
                <input class="form-check-input" type="checkbox" value="1" id="refresh-check-box">
                <label class="form-check-label"  for="refresh-check-box">
                    auto Refresh
                </label>
            </div>
            <!--Auto Refresh-Knopf-->
            <!--<button id="auto-refresh" type="button" class=" btn  btn-info mt-1">Start auto Refresh</button>-->
            <!--Refresh-Knopf-->
            <button id="refresh" type="button" class=" btn  btn-info mt-1">Reload</button>
        </div>
    </div>
    <!--Ausgabe Status-->
    <div id="stat" class="card mt-3">
        <div class="card-header "> Status</div>
        <div class="card-body h-50 ">
            <button id="bt_state_ready">Ready</button>
            <button id="bt_state_startet">Gestartet</button>
            <button id="bt_state_runing">Läuft</button>
            <button id="bt_state_finsish">Fertig</button>
            <div id="random-card" class="card-text">Zeit bis Start: <span id="random"></span></div>
        </div>
    </div>
    <!--Ausgabe Zeiten-->
    <div class="card mt-3">
        <div class="card-header "> Zeit</div>
        <div class="card-body h-50 ">
            <div class="container">
                <div class="row">
                    <div class="col">
                        <!--Links-->
                        <div class="card border-1">
                            <div class="card-header">Links </div>
                            <div class="card-body">
                                <button id="bt_state_LStart">Start</button>
                                <button id="bt_state_L1">L1</button>
                                <button id="bt_state_L2">L2</button>
                                <button id="bt_state_L3">L3</button>
                                <button id="bt_state_LSieg">Sieg</button>
                                <button id="bt_state_lFuehstart">Frühstart</button>
<!--                                <div class="card-text"> <span>Reaktionszeit: </span><span  id="LReak"></span> </div>-->
                                <div class="card-text"> <span>Reaktionszeit: </span><span  id="L1"></span> </div>
                                <div class="card-text"> <span>Geschwindigkeit: </span><span  id="L2"></span> </div>
                                <div class="card-text"> <span>Gesamtzeit: </span><span  id="L3"></span> </div>

                            </div>
                        </div>

                    </div>
                    <div class="col">
                        <!--Rechts-->
                        <div class="card">
                            <div class="card-header">Rechts </div>
                        </div>

                    </div>

                </div>
            </div>
            <p id="zahl">Zahl</p>
        </div>
    </div>

    <!--Simulator-->
    <div id="sim" class="card mt-3">
        <div class="card-header "> Lichtschranken Simulator</div>
        <div class="card-body h-50 ">
            <button id="bt_sim_L1">L1</button>
            <button id="bt_sim_L2">L2</button>
            <button id="bt_sim_L3">L3</button>
            <button id="bt_sim_R1">R1</button>
            <button id="bt_sim_R2">R2</button>
            <button id="bt_sim_R3">R3</button>
        </div>
    </div>



</div>



</body>
</html>